<!DOCTYPE html>
<html>

<body>
    <h1>Zetrix Wallet Integration (TEST)</h1>

</body>
<script type="module">
    import ZetrixWalletConnect from "https://cdn.skypack.dev/zetrix-connect-wallet-sdk@1.1.3";

    const options = {
        bridge: 'wss://test-wscw.zetrix.com'
    }

    var zetrixConnect = new ZetrixWalletConnect({
        qrcode: false,
    });

    zetrixConnect.connect(options);

    const test = () => {
        document.getElementById("callAuthStatus").innerHTML = "Calling Auth";
        zetrixConnect
            .auth()
            .then((res) => {
                //Flutter.postMessage(JSON.stringify(res));
                document.getElementById("walletAddress").innerHTML = res.data.address;
                const walletAddress = res.data.address;
                preAuth(walletAddress);
            })
            .catch((e) => {
                console.log(e);
                //document.getElementById("test2").innerHTML = JSON.stringify(e);
            });
    };

    const preAuth = async (walletAddress) => {
        const url = 'https://ssivc-api-dev.myegdev.com/api/preauth';
        // Data to send with the POST request
        const data = {
            wallet_address: walletAddress,
            chainId: '2'
        };
        // Options for the POST request
        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        };
        // Make the POST request
        try {
            fetch(url, options)
                .then(response => response.json())
                .then(json => {
                    console.log(JSON.stringify(json));
                    setTimeout(() => sign(json.data.signMessage), 3000);
                })

        } catch (error) {
            console.error(error);
        }
    }

    const sign = (signMessage) => {
        //document.getElementById("signMessageStatus").innerHTML = "Signing Now";
        zetrixConnect.signMessage({ message: signMessage })
            .then(async (res) => {
                //document.getElementById("signMessageStatus").innerHTML = JSON.stringify(res);
                console.log(JSON.stringify(res));
                const loginData = {
                    signBlob: res.data.signData,
                    chainId: 2,
                    publicKey: res.data.publicKey,
                    blob: signMessage,
                    address: res.data.address
                };
                await login(loginData);
            })
            .catch((e) => console.log('ERROR: ' + JSON.stringify(e)));
    };

    const login = async (loginData) => {
        const url = 'https://ssivc-api-dev.myegdev.com/api/login';

        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(loginData)
        };

        try {
            await fetch(url, options)
                .then(response => response.json())
                .then(json => {
                    console.log(json.data);
                    document.getElementById("accessToken").innerHTML = json.data;
                    
                })
        } catch (error) {
            console.error(error);
        }

    }

    setTimeout(test, 1000);

</script>
<span id="callAuthStatus">No Update</span><br />
<br />
<span id="signMessageStatus">No Update</span>
<span id="walletAddress" style="color: black;"></span>
<span id="accessToken" style="color: black;"></span>

</html>
